<!--
Full single-file web app (index.html) for Indus Boys Hostel Portal with:
- OneSignal push notifications (client-side snippet included; replace YOUR_ONESIGNAL_APP_ID)
- Service worker files required (OneSignal SDK worker files shown below ‚Äî place them at your server root)
- Modern glassmorphism UI, header dropdown, profile modal, team/developer cards
- PDF export (html2pdf.js) with a redesigned receipt layout

IMPORTANT:
- This must be served over HTTPS (or localhost) for service workers & push to work.
- Create a OneSignal Web Push app and paste your APP ID into the ONESIGNAL_APP_ID constant in the script.
- Upload the two OneSignal worker files (OneSignalSDKWorker.js and OneSignalSDKUpdaterWorker.js) to your webserver root alongside this index.html. Example content for them is included at the bottom of this file as commented blocks.

Save this as `index.html` and host with HTTPS. Replace placeholders before testing.
-->

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Indus Boys Hostel ‚Äî Resident Portal (OneSignal)</title>

<!-- OneSignal SDK (will load if served via https) -->
<script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" async></script>

<!-- html2pdf for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --bg: #0f172a;
    --card: rgba(255,255,255,0.04);
    --glass: rgba(255,255,255,0.04);
    --muted: #94a3b8;
    --accent: linear-gradient(135deg,#06b6d4,#0ea5e9);
    --glass-border: rgba(255,255,255,0.06);
    --success: #10b981;
    --danger: #ef4444;
    --radius: 14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;color:#e6eef8;background:linear-gradient(180deg,#071029 0%, #081430 70%);}

  .app-header{position:sticky;top:0;z-index:60;background:rgba(255,255,255,0.02);backdrop-filter:blur(6px);border-bottom:1px solid var(--glass-border);}
  .header-content{display:flex;align-items:center;gap:12px;padding:12px 18px;max-width:1100px;margin:0 auto;}
  .brand{display:flex;align-items:center;gap:12px;cursor:pointer}
  .brand-logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#06b6d4,#0ea5e9);display:flex;align-items:center;justify-content:center;font-weight:800;color:#052025}
  .brand-title{font-weight:700}
  .header-actions{margin-left:auto;display:flex;align-items:center;gap:10px}

  .icon-btn{background:transparent;border:1px solid var(--glass-border);padding:8px;border-radius:10px;color:#cfe7f7;cursor:pointer}

  /* dropdown */
  .profile-btn{display:flex;align-items:center;gap:8px;cursor:pointer;position:relative}
  .profile-avatar{width:40px;height:40px;border-radius:50%;overflow:hidden;border:2px solid rgba(255,255,255,0.06)}
  .profile-avatar img{width:100%;height:100%;object-fit:cover}
  .dropdown{position:absolute;right:0;top:calc(100% + 8px);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--glass-border);padding:10px;border-radius:12px;min-width:220px;box-shadow:0 8px 30px rgba(2,6,23,0.6);display:none}
  .dropdown.show{display:block}
  .dropdown a{display:flex;gap:10px;padding:8px;border-radius:8px;color:#cfe7f7;text-decoration:none}
  .dropdown a:hover{background:rgba(255,255,255,0.02)}

  .app-container{max-width:1100px;margin:20px auto;padding:0 18px 120px}
  .grid{display:grid;grid-template-columns:1fr;gap:18px}
  @media(min-width:960px){.grid{grid-template-columns:360px 1fr}}

  /* left column */
  .left-column{display:flex;flex-direction:column;gap:18px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border:1px solid var(--glass-border);padding:16px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .card h3{margin:0 0 8px 0;font-size:16px}
  .muted{color:var(--muted);font-size:13px}

  .profile-large{display:flex;gap:12px;align-items:center}
  .profile-large .avatar{width:72px;height:72px;border-radius:12px;overflow:hidden}
  .profile-large .avatar img{width:100%;height:100%;object-fit:cover}
  .profile-large .meta{flex:1}
  .edit-btn{padding:8px 10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:#cfe7f7;cursor:pointer}

  /* team list */
  .team-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .team-card{padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.015),transparent);display:flex;gap:10px;align-items:center}
  .team-card img{width:56px;height:56px;border-radius:10px;object-fit:cover}

  /* right column */
  .meals-header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .days-row{display:flex;gap:8px;margin:12px 0;overflow:auto}
  .day-pill{padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);background:transparent;color:#cfe7f7;cursor:pointer;white-space:nowrap}
  .day-pill.active{background:linear-gradient(90deg,#06b6d4,#0ea5e9);color:#002d32}

  .meals-grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:680px){.meals-grid{grid-template-columns:repeat(2,1fr)}}
  .meal-card{padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg,rgba(255,255,255,0.015),transparent)}
  .meal-name{font-weight:700;margin-bottom:6px}
  .meal-time{font-size:13px;color:var(--muted);margin-bottom:8px}
  .meal-items{font-size:14px;color:#d9eefb}
  .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700}
  .badge.live{background:linear-gradient(90deg,#10b981,#059669);color:white}
  .badge.next{background:linear-gradient(90deg,#0ea5e9,#0284c7);color:white}

  /* notification */
  .info-card{display:flex;gap:12px;align-items:flex-start}
  .info-icon{width:42px;height:42px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
  .info-content .title{font-weight:800}
  .info-content .text{color:var(--muted);font-size:14px}

  /* receipt preview */
  .receipt-preview{margin-top:12px;border-radius:12px;padding:14px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);border:1px solid var(--glass-border)}
  .receipt-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}

  /* pdf print theme (for export) */
  #receiptForPdf{width:800px;padding:28px;font-family:Inter,Arial;background:white;color:#052025}
  #receiptForPdf .pdf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  #receiptForPdf .pdf-brand{display:flex;gap:12px;align-items:center}
  #receiptForPdf .pdf-brand .logo{width:72px;height:72px;border-radius:12px;background:linear-gradient(90deg,#06b6d4,#0ea5e9);display:flex;align-items:center;justify-content:center;font-weight:800;color:#052025}
  #receiptForPdf .pdf-title{font-weight:800;font-size:20px}
  #receiptForPdf .pdf-meta{font-size:13px;color:#334155}
  #receiptForPdf .pdf-body{margin-top:12px}
  #receiptForPdf .pdf-table{width:100%;border-collapse:collapse;margin-top:12px}
  #receiptForPdf .pdf-table td{padding:10px;border-bottom:1px solid #eef2f7}
  #receiptForPdf .pdf-footer{display:flex;justify-content:space-between;margin-top:18px;align-items:center}
  #receiptForPdf .signature{height:60px}

  /* footer / bottom nav */
  .bottom-actions{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;border-radius:999px;border:1px solid var(--glass-border);display:flex;gap:8px}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;color:#cfe7f7;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,#06b6d4,#0ea5e9);color:#002d32;border:none}

  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:none;align-items:center;justify-content:center;padding:20px}
  .modal-backdrop.show{display:flex}
  .modal{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:18px;border-radius:12px;min-width:320px;border:1px solid var(--glass-border)}
  input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8;margin-top:8px}
  label{font-size:13px;color:var(--muted);}
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="app-header">
    <div class="header-content">
      <div class="brand" id="brandHome">
        <div class="brand-logo">IBH</div>
        <div>
          <div class="brand-title">Indus Boys Hostel</div>
          <div class="muted" style="font-size:12px">Resident Portal</div>
        </div>
      </div>

      <div class="header-actions">
        <button class="icon-btn" id="toggleTheme" title="Toggle theme">üåì</button>

        <div class="profile-btn" id="profileBtn">
          <div class="profile-avatar"><img id="headerAvatar" src="https://i.postimg.cc/ThkGgFs4/member.png" alt="avatar"></div>
          <div style="color:#cfe7f7;font-weight:700;">Israr</div>

          <div class="dropdown" id="profileDropdown">
            <a href="#" id="viewProfileBtn">üëÅÔ∏è View Profile</a>
            <a href="#" id="editProfileBtn">‚úèÔ∏è Edit Profile</a>
            <a href="#" id="myReceiptsBtn">üßæ My Receipts</a>
            <a href="#" id="signOutBtn">üö™ Sign Out</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="app-container">
    <div class="grid">
      <!-- LEFT COLUMN -->
      <div class="left-column">
        <div class="card">
          <div class="profile-large">
            <div class="avatar"><img id="profileLargeImg" src="https://i.postimg.cc/ThkGgFs4/member.png" alt="avatar"></div>
            <div class="meta">
              <div id="profileName" style="font-weight:800">Guest User</div>
              <div class="muted" id="profileRole">Hostel Resident ‚Ä¢ Room -</div>
              <div style="margin-top:8px;display:flex;gap:8px">
                <button class="edit-btn" id="openEditProfile">Edit Profile</button>
                <button class="edit-btn" id="notifySubscribe">Enable Push</button>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Management</h3>
          <div class="team-grid" id="teamGrid">
            <!-- team cards injected here -->
          </div>
        </div>

        <div class="card">
          <h3>Quick Links</h3>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button class="btn" id="openRules">üìú Terms & Rules</button>
            <button class="btn" id="openSignUp">‚ûï Create Profile</button>
            <button class="btn" id="openTeamManager">üë• Team Manager</button>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div>
        <div class="card">
          <div class="meals-header">
            <div>
              <div style="font-weight:800;font-size:18px" id="welcomeMsg">Welcome!</div>
              <div class="muted" id="todayDate">‚Äî</div>
            </div>
            <div style="text-align:right">
              <div class="muted">Time</div>
              <div style="font-weight:800" id="clock">--:--</div>
            </div>
          </div>

          <div class="days-row" id="daySelector"></div>

          <div class="meals-grid" id="mealsContainer"></div>

          <div class="card" style="margin-top:12px">
            <div class="info-card" id="mealNotification"></div>
          </div>
        </div>

        <div class="card" style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Residents</div>
              <div class="muted">Current hostel residents</div>
            </div>
            <div>
              <input id="searchName" type="text" placeholder="Search name or roll" style="padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8">
              <button class="btn" id="searchBtn">üîç</button>
            </div>
          </div>

          <div id="studentsList" style="margin-top:12px"></div>
        </div>

        <div class="card" style="margin-top:18px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Generate Receipt</div>
              <div class="muted">Search a student and download a polished PDF receipt</div>
            </div>
          </div>

          <div id="searchResult" style="margin-top:12px"></div>
          <div id="receiptPreviewContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- BOTTOM ACTIONS -->
  <div class="bottom-actions">
    <button class="btn" id="openTeam">üë• Team</button>
    <button class="btn" id="openReceipts">üßæ Receipts</button>
    <button class="btn primary" id="downloadAllReceipts">Export PDF</button>
  </div>

  <!-- MODALS -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modalContent"></div>
  </div>

  <!-- Hidden PDF receipt element (used for export) -->
  <div id="receiptForPdf" style="display:none"></div>

<script>
/* ================== CONFIG ================== */
// Replace this with your OneSignal App ID (web push)
const ONESIGNAL_APP_ID = 'YOUR_ONESIGNAL_APP_ID';

/* ================== SAMPLE DATA ================== */
const studentsData = [
  { name: "Ali Khan", rollNumber: "HS-101", feePaid: 1200, datePaid: "2024-09-15", phone: "+923001112233" },
  { name: "Ayesha Baloch", rollNumber: "HS-102", feePaid: 1150, datePaid: "2024-09-10", phone: "+923009998877" },
  { name: "Faizan Ahmed", rollNumber: "HS-103", feePaid: 1250, datePaid: "2024-08-30", phone: "+923004445566" },
  { name: "Sara Noor", rollNumber: "HS-104", feePaid: 1200, datePaid: "2024-09-20", phone: "+923007776655" },
  { name: "Israr Sindhi", rollNumber: "HS-105", feePaid: 1100, datePaid: "2024-09-07", phone: "+923001234567" }
];

const mealSchedule = {
  Monday: { Breakfast: { time: "7:00 AM - 8:00 AM", item: "Paratha, Eggs, Tea" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Chicken Biryani, Raita" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Mixed Veg, Chapati" } },
  Tuesday: { Breakfast: { time: "7:00 AM - 8:00 AM", item: "Halwa Puri, Tea" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Beef Karahi, Rice" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Daal, Rice, Salad" } },
  Wednesday: { Breakfast: { time: "7:00 AM - 8:00 AM", item: "Oats, Fruit, Milk" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Pulao, Chicken Karahi" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Kabab, Paratha" } },
  Thursday: { Breakfast: { time: "7:00 AM - 8:00 AM", item: "Egg Omelette, Toast, Tea" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Qorma, Naan" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Spaghetti, Garlic Bread" } },
  Friday: { Breakfast: { time: "7:30 AM - 8:30 AM", item: "Chai & Samosa" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Special Biryani" }, Dinner: { time: "7:00 PM - 8:30 PM", item: "Grilled Chicken, Salad" } },
  Saturday: { Breakfast: { time: "8:00 AM - 9:00 AM", item: "Pancakes, Syrup" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Fish Curry, Rice" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Vegetable Stir Fry" } },
  Sunday: { Breakfast: { time: "8:00 AM - 9:00 AM", item: "Paratha, Yogurt" }, Lunch: { time: "1:00 PM - 2:00 PM", item: "Karahi, Rice" }, Dinner: { time: "7:00 PM - 8:00 PM", item: "Mix Grill, Naan" } }
};

const paidToStaff = [
  { id:'faiq', name:'Mr. Faiq Ali', title:'Accountant', signature: 'Faiq Ali' },
  { id:'ali', name:'Mr. Ali Faheem', title:'Warden', signature: 'Ali Faheem' },
  { id:'saeed', name:'Dr. Saeed Bapar', title:'Director', signature: 'Saeed Bapar' }
];

const teamMembers = [
  {name:'Mr. Faiq Ali', role:'Accountant', img:'https://i.postimg.cc/9FrGkFmn/Gemini-Generated-Image-76whby76whby76wh.png'},
  {name:'Mr. Ali Faheem', role:'Warden', img:'https://i.postimg.cc/5N6wrN4Z/Gemini-Generated-Image-8sktjf8sktjf8skt.png'},
  {name:'Dr. Saeed Bapar', role:'Director', img:'https://i.postimg.cc/ZKKf5STf/Gemini-Generated-Image-mctpyfmctpyfmctp.png'},
  {name:'Israr Sindhi', role:'Developer', img:'https://i.postimg.cc/ThkGgFs4/member.png'}
];

/* ================== UTIL ================== */
function formatTime(d){return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});} 
function maskPhone(phone){ if(!phone) return ''; const clean=phone.replace(/[^0-9+]/g,''); const plus=clean.startsWith('+')?'+':''; let digits=plus?clean.slice(1):clean; if(digits.length<=6) return plus+digits; const first=digits.slice(0,4), last=digits.slice(-3); const midLen=Math.max(3,digits.length-7); return plus+first+'*'.repeat(midLen)+last; }

/* ================== MEAL TIME PARSING (robust) ================== */
function parseRange(rangeStr){ const parts=rangeStr.split('-').map(x=>x.trim()); function p(part){ const m=part.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i); if(m){ let hh=parseInt(m[1],10); const mm=parseInt(m[2],10); const ap=m[3].toUpperCase(); if(ap==='PM'&&hh!==12) hh+=12; if(ap==='AM'&&hh===12) hh=0; const d=new Date(); d.setHours(hh,mm,0,0); return d;} return null;} const s=p(parts[0]); const e=p(parts[1]||parts[0]); if(!s||!e) return [s,e]; if(e<=s) e.setDate(e.getDate()+1); return [s,e]; }

function minutesUntil(date){ return Math.round((date - new Date())/60000); }

function getMealStatus(day){ const now=new Date(); const arr=Object.entries(mealSchedule[day]).map(([name,info])=>{ const [s,e]=parseRange(info.time); return { mealName:name, start:s, end:e, info }; }); const ongoing=arr.find(a=> now>=a.start && now<=a.end); if(ongoing) return { type:'ongoing', meal: ongoing }; const upcoming=arr.filter(a=> a.start>now).sort((a,b)=>a.start-b.start)[0]; if(upcoming) return { type:'upcoming', meal: upcoming }; const tIdx=(Object.keys(mealSchedule).indexOf(day)+1)%7; const nextDay=Object.keys(mealSchedule)[tIdx]; const nextArr=Object.entries(mealSchedule[nextDay]).map(([name,info])=>({ mealName:name, start:parseRange(info.time)[0], end:parseRange(info.time)[1], info })); const next=nextArr.sort((a,b)=>a.start-b.start)[0]; return { type:'nextday', meal: next, day: nextDay }; }

/* ================== RENDER UI ================== */
function renderDaySelector(){ const selector=document.getElementById('daySelector'); selector.innerHTML=''; const weekDays=Object.keys(mealSchedule); const todayName=new Date().toLocaleDateString([], { weekday:'long' }); weekDays.forEach(day=>{ const btn=document.createElement('div'); btn.className='day-pill'; btn.textContent=day; btn.dataset.day=day; if(day===todayName) btn.classList.add('active'); btn.addEventListener('click', ()=>{ document.querySelectorAll('.day-pill').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderMealsForDay(day); }); selector.appendChild(btn); }); renderMealsForDay(new Date().toLocaleDateString([], { weekday:'long' })); }

function renderMealsForDay(day){ const container=document.getElementById('mealsContainer'); container.innerHTML=''; const obj=mealSchedule[day]; const status=getMealStatus(day); ['Breakfast','Lunch','Dinner'].forEach(mealName=>{ const info=obj[mealName]; const [s,e]=parseRange(info.time); const card=document.createElement('div'); card.className='meal-card'; let statusBadge=''; if(status.type==='ongoing'&&status.meal.mealName===mealName){ statusBadge='<span class="badge live">LIVE</span>'; } else if(status.type==='upcoming'&&status.meal.mealName===mealName){ statusBadge='<span class="badge next">NEXT</span>'; } card.innerHTML=`<div class="meal-name">${mealName} ${statusBadge}</div><div class="meal-time">${formatTime(s)} - ${formatTime(e)}</div><div class="meal-items">${info.item}</div>`; container.appendChild(card); }); updateMealNotification(day); }

function updateMealNotification(day){ const status=getMealStatus(day); const notification=document.getElementById('mealNotification'); let icon='üçΩÔ∏è', iconClass='info', title='', text=''; if(status.type==='ongoing'){ icon='‚úÖ'; title=`${status.meal.mealName} is being served now`; text=`${formatTime(status.meal.start)} - ${formatTime(status.meal.end)} ‚Ä¢ ${status.meal.info.item}`; } else if(status.type==='upcoming'){ const mins=minutesUntil(status.meal.start); icon='‚è∞'; title=`${status.meal.mealName} starts in ${mins} minute${Math.abs(mins)!==1?'s':''}`; text=status.meal.info.item; } else { const mins=minutesUntil(status.meal.start); icon='üìÖ'; title=`Next: ${status.meal.mealName} (${status.day})`; text=`Starts in ${Math.max(0,mins)} minutes ‚Ä¢ ${status.meal.info.item}`; } notification.innerHTML=`<div class="info-icon">${icon}</div><div class="info-content"><div class="title">${title}</div><div class="text">${text}</div></div>`; }

function renderStudentsList(){ const list=document.getElementById('studentsList'); list.innerHTML=''; studentsData.forEach(s=>{ const item=document.createElement('div'); item.className='student-item'; item.innerHTML=`<div><div style="font-weight:800">${s.name}</div><div class="muted">${s.rollNumber}</div></div><div class="muted">${maskPhone(s.phone)}</div>`; list.appendChild(item); }); }

function renderTeam(){ const grid=document.getElementById('teamGrid'); grid.innerHTML=''; teamMembers.forEach(m=>{ const card=document.createElement('div'); card.className='team-card'; card.innerHTML=`<img src="${m.img}" alt="${m.name}"><div><div style="font-weight:800">${m.name}</div><div class="muted">${m.role}</div></div>`; grid.appendChild(card); }); }

/* ================== PROFILE & DROPDOWN ================== */
const profileBtn=document.getElementById('profileBtn'); const profileDropdown=document.getElementById('profileDropdown'); profileBtn.addEventListener('click', (e)=>{ profileDropdown.classList.toggle('show'); });

// Close dropdown on outside click
window.addEventListener('click', (e)=>{ if(!profileBtn.contains(e.target)) profileDropdown.classList.remove('show'); });

function openModal(html){ document.getElementById('modalContent').innerHTML=html; document.getElementById('modalBackdrop').classList.add('show'); }
function closeModal(){ document.getElementById('modalBackdrop').classList.remove('show'); }

/* ========== Edit Profile Modal ========== */
function showEditProfile(){ const saved=JSON.parse(localStorage.getItem('hostel_profile')||'{}'); openModal(`
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><div style="font-weight:800">Edit Profile</div><button id=closeModalBtn class='btn'>‚úñ</button></div>
  <label>Full Name</label><input id='mName' value='${saved.name||''}' />
  <label>Roll Number</label><input id='mRoll' value='${saved.roll||''}' />
  <label>Email</label><input id='mEmail' value='${saved.email||''}' />
  <label>Phone</label><input id='mPhone' value='${saved.phone||''}' />
  <label>Room</label><input id='mRoom' value='${saved.room||''}' />
  <div style="display:flex;gap:8px;margin-top:12px"><button class='btn primary' id='saveProfileModal'>Save</button><button class='btn' id='cancelProfileModal'>Cancel</button></div>
`);

document.getElementById('closeModalBtn').addEventListener('click', closeModal);
document.getElementById('cancelProfileModal').addEventListener('click', closeModal);

document.getElementById('saveProfileModal').addEventListener('click', ()=>{
  const profile={ name: document.getElementById('mName').value.trim(), roll: document.getElementById('mRoll').value.trim(), email: document.getElementById('mEmail').value.trim(), phone: document.getElementById('mPhone').value.trim(), room: document.getElementById('mRoom').value.trim(), avatar: document.getElementById('profileLargeImg').src };
  if(!profile.name){ alert('Name required'); return; }
  localStorage.setItem('hostel_profile', JSON.stringify(profile)); applyProfile(); closeModal();
});
}

function applyProfile(){ const saved=JSON.parse(localStorage.getItem('hostel_profile')||'{}'); if(saved.name) document.getElementById('profileName').textContent=saved.name; if(saved.room) document.getElementById('profileRole').textContent=`Hostel Resident ‚Ä¢ Room ${saved.room}`; if(saved.avatar){ document.getElementById('profileLargeImg').src=saved.avatar; document.getElementById('headerAvatar').src=saved.avatar; }}

/* ========== SEARCH & RECEIPT ========== */
document.getElementById('searchBtn').addEventListener('click', ()=>{ const q=document.getElementById('searchName').value.trim().toLowerCase(); const res=document.getElementById('searchResult'); const preview=document.getElementById('receiptPreviewContainer'); preview.innerHTML=''; if(!q){ res.innerHTML='<div class="muted">Please enter a search term</div>'; return; } const student=studentsData.find(s=> s.name.toLowerCase().includes(q) || s.rollNumber.toLowerCase().includes(q)); if(student){ res.innerHTML=`<div style="display:flex;align-items:center;gap:10px"><div style="font-weight:800">${student.name}</div><div class="muted">${student.rollNumber}</div></div>`; renderReceiptPreview(student); } else { res.innerHTML='<div class="muted">Student not found</div>'; } });

function renderReceiptPreview(student){ const container=document.getElementById('receiptPreviewContainer'); container.innerHTML=`
  <div class="receipt-preview">
    <div style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">Receipt Preview</div><div class='muted'>${student.name} ‚Ä¢ ${student.rollNumber}</div></div><div><button class='btn' id='editReceiptBtn'>Edit</button><button class='btn primary' id='downloadPdfBtn'>Download PDF</button></div></div>
    <div style="margin-top:12px">
      <div class="receipt-row"><div class="muted">Student</div><div style="font-weight:800">${student.name}</div></div>
      <div class="receipt-row"><div class="muted">Roll</div><div style="font-weight:800">${student.rollNumber}</div></div>
      <div class="receipt-row"><div class="muted">Phone</div><div>${student.phone}</div></div>
      <div class="receipt-row"><div class="muted">Amount</div><div style="font-weight:800">${student.feePaid} PKR</div></div>
      <div style="margin-top:12px">
        <label class='muted'>Paid To</label>
        <select id='paidToSelect' style='margin-top:6px'>${paidToStaff.map(p=>`<option value="${p.id}">${p.name} (${p.title})</option>`).join('')}</select>
      </div>
      <div style="margin-top:8px"><label class='muted'>Date Paid</label><input id='datePaidInput' value='${student.datePaid}' /></div>
    </div>
  </div>
`;

  document.getElementById('downloadPdfBtn').addEventListener('click', ()=>{
    const paidToId=document.getElementById('paidToSelect').value; const datePaid=document.getElementById('datePaidInput').value; generatePDF(student, paidToId, datePaid);
  });
}

/* ========== PDF GENERATION (html2pdf) ========== */
function generatePDF(student, paidToId, datePaid){ const paidTo = paidToStaff.find(p=>p.id===paidToId) || paidToStaff[0]; const invoiceNo = 'IBH-' + Date.now().toString(36).slice(-6).toUpperCase(); const receiptEl = document.getElementById('receiptForPdf'); receiptEl.style.display='block'; receiptEl.innerHTML = `
  <div class='pdf-header'>
    <div class='pdf-brand'><div class='logo'>IBH</div><div><div class='pdf-title'>Indus Boys Hostel</div><div class='pdf-meta'>Fee Receipt</div></div></div>
    <div style='text-align:right'><div style='font-weight:800'>${invoiceNo}</div><div class='pdf-meta'>Date: ${datePaid}</div></div>
  </div>
  <div class='pdf-body'>
    <table class='pdf-table'>
      <tr><td>Student Name</td><td>${student.name}</td></tr>
      <tr><td>Roll Number</td><td>${student.rollNumber}</td></tr>
      <tr><td>Phone</td><td>${student.phone}</td></tr>
      <tr><td>Amount (PKR)</td><td>${student.feePaid}</td></tr>
      <tr><td>Amount (Words)</td><td>${numberToWords(student.feePaid)} Rupees Only</td></tr>
      <tr><td>Paid To</td><td>${paidTo.name} (${paidTo.title})</td></tr>
    </table>
    <div class='pdf-footer'>
      <div><div class='muted'>Prepared by</div><div style='font-weight:800'>Indus Boys Hostel</div></div>
      <div style='text-align:right'><div class='muted'>Signature</div><div class='signature'>${paidTo.signature}</div></div>
    </div>
  </div>
`;

  // options for html2pdf
  const opt = { margin:0.4, filename:`${student.rollNumber}-${invoiceNo}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2, useCORS:true}, jsPDF:{unit:'in',format:'letter',orientation:'portrait'}};
  html2pdf().set(opt).from(receiptEl).save().then(()=>{ receiptEl.style.display='none'; }).catch(err=>{ console.error(err); receiptEl.style.display='none'; }); }

/* ================== UTILS: words & receipt id ================== */
function numberToWords(num){ if(isNaN(num)||num===0) return 'Zero'; const a=['','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen']; const b=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety']; function words(n){ if(n<20) return a[n]; if(n<100) return b[Math.floor(n/10)] + (n%10? ' ' + a[n%10] : ''); if(n<1000) return a[Math.floor(n/100)] + ' Hundred' + (n%100? ' ' + words(n%100) : ''); if(n<1000000) return words(Math.floor(n/1000)) + ' Thousand' + (n%1000? ' ' + words(n%1000) : ''); return words(Math.floor(n/1000000)) + ' Million' + (n%1000000? ' ' + words(n%1000000) : ''); } return words(num); }

/* ================== ONE SIGNAL SETUP ================== */
function initOneSignal(){ if(!ONESIGNAL_APP_ID || ONESIGNAL_APP_ID==='YOUR_ONESIGNAL_APP_ID'){ console.warn('OneSignal App ID not set. Push will not initialize.'); return; }
  window.OneSignal = window.OneSignal || [];
  OneSignal.push(function() {
    OneSignal.init({
      appId: ONESIGNAL_APP_ID,
      notifyButton: { enable: false },
      welcomeNotification: {"title":"Welcome","message":"Thanks for enabling notifications from Indus Boys Hostel"}
    });

    // optional: show native prompt to subscribe
    document.getElementById('notifySubscribe').addEventListener('click', ()=>{
      OneSignal.showNativePrompt();
    });

    // Listen for subscription change
    OneSignal.on('subscriptionChange', function(isSubscribed) {
      console.log('OneSignal subscription changed:', isSubscribed);
      if(isSubscribed) showToast('Push notifications enabled'); else showToast('Push notifications disabled');
    });

    // Example: send a local notification when meal status changes while page open
    // (Server side should send scheduled notifications for closed/terminated app.)
  });
}

/* ================== SCHEDULER: push when meal starts (requires server for closed app) ================== */
// NOTE: For notifications while app is closed you MUST configure OneSignal dashboard REST API or use server SDK to schedule/push notifications.
// The following client code demonstrates local detection while page is open and will show an in-browser notification via OneSignal (if allowed).
let lastNotified = null;
function checkAndNotify(){ const today = new Date().toLocaleDateString([], { weekday: 'long'}); const status = getMealStatus(today); if(status && status.type==='ongoing'){ const key = `${today}-${status.meal.mealName}`; if(lastNotified!==key){ lastNotified=key; // show in-app toast
    showToast(`${status.meal.mealName} is being served now`);
    // trigger OneSignal notification (requires permission and OneSignal init)
    if(window.OneSignal){ OneSignal.push(function(){ OneSignal.isPushNotificationsEnabled().then(function(enabled){ if(enabled){ OneSignal.sendSelfNotification(
        'Meal Started',
        `${status.meal.mealName} ‚Ä¢ ${status.meal.info.item}`,
        'https://indusboyshostel.example/meal',
        {data:{meal:status.meal.mealName}},
        {buttons:[{id:'open',text:'View'}]}
      ); } }); }); }
  }} }

/* ================== INIT UI ================== */
function updateClockGreeting(){ const now=new Date(); document.getElementById('clock').textContent = formatTime(now); document.getElementById('todayDate').textContent = now.toLocaleDateString([], { weekday:'long', month:'long', day:'numeric' }); const h=now.getHours(); let g='Good Evening'; if(h<12) g='Good Morning'; else if(h<17) g='Good Afternoon'; document.getElementById('welcomeMsg').textContent=g; }

// wire actions
document.getElementById('openEditProfile').addEventListener('click', ()=>{ showEditProfile(); });
document.getElementById('editProfileBtn').addEventListener('click',(e)=>{ e.preventDefault(); showEditProfile(); profileDropdown.classList.remove('show'); });
document.getElementById('viewProfileBtn').addEventListener('click',(e)=>{ e.preventDefault(); const saved=JSON.parse(localStorage.getItem('hostel_profile')||'{}'); openModal(`<div style="font-weight:800">Profile</div><div style='margin-top:8px'><strong>${saved.name||'Guest'}</strong><div class='muted'>${saved.roll||''}</div><div class='muted'>${saved.email||''}</div><div class='muted'>${saved.phone||''}</div></div><div style='text-align:right;margin-top:12px'><button class='btn' id='closeModalView'>Close</button></div>`); document.getElementById('closeModalView').addEventListener('click', closeModal); profileDropdown.classList.remove('show'); });

// modal backdrop click -> close
document.getElementById('modalBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='modalBackdrop') closeModal(); });

// Search enter key
document.getElementById('searchName').addEventListener('keypress',(e)=>{ if(e.key==='Enter') document.getElementById('searchBtn').click(); });

// Download all receipts quick demo (exports empty template)
document.getElementById('downloadAllReceipts').addEventListener('click', ()=>{ showToast('Exporting sample receipt...'); const sample=studentsData[0]; generatePDF(sample, paidToStaff[0].id, sample.datePaid); });

/* ================== STARTUP ================== */
renderDaySelector(); renderStudentsList(); renderTeam(); applyProfile(); updateClockGreeting(); setInterval(updateClockGreeting,60000); setInterval(checkAndNotify,30000); initOneSignal();

/* ================== TOAST ========== */
function showToast(msg){ const el=document.createElement('div'); el.style.position='fixed'; el.style.bottom='110px'; el.style.left='50%'; el.style.transform='translateX(-50%)'; el.style.background='linear-gradient(90deg,#06b6d4,#0ea5e9)'; el.style.color='#042022'; el.style.padding='10px 14px'; el.style.borderRadius='10px'; el.style.boxShadow='0 10px 30px rgba(2,6,23,0.6)'; el.style.zIndex=9999; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>{ el.style.transition='opacity 0.3s'; el.style.opacity='0'; setTimeout(()=>el.remove(),350); },3000); }

/* ================== SERVICE WORKER REGISTRATION (for push) ================== */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('/OneSignalSDKWorker.js').then(reg=>{ console.log('Service worker registered:', reg); }).catch(err=>console.warn('SW register fail',err)); }

/* ================== NOTES ================== */
// 1) You must host the two OneSignal worker files at the root of your site: /OneSignalSDKWorker.js and /OneSignalSDKUpdaterWorker.js
// 2) For closed-app push notifications, configure OneSignal Dashboard or call its REST API from a server to schedule notifications at meal start times.
// 3) Replace ONESIGNAL_APP_ID above with your OneSignal App ID.

</script>

<!-- ================== OneSignal worker files (place these at your server root) ==================
  Create files at the web root: OneSignalSDKWorker.js and OneSignalSDKUpdaterWorker.js
  Example content (both files can be identical):

  // OneSignalSDKWorker.js
  importScripts('https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js');

  // OneSignalSDKUpdaterWorker.js
  importScripts('https://cdn.onesignal.com/sdks/OneSignalSDKWorker.js');

  Save both of the above at the root alongside index.html. OneSignal requires them to be available at the origin root to deliver push while page is closed.

  ========================================================================================= -->

</body>
</html>
